<!-- <!DOCTYPE html>
<html>
<head>
	<title>Speech Synthesis Example</title>
</head>
<body>
	<h1>Speech Synthesis Example</h1>
	<p>Enter text to be spoken:</p>
	<textarea id="text-to-speak"></textarea>
	<br>
	<button onclick="speak()">Speak</button>

	<script>
		// Create a new instance of SpeechSynthesisUtterance
		var utterance = new SpeechSynthesisUtterance();

		function speak() {
			// Get the text to be spoken
			var text = document.getElementById("text-to-speak").value;

			// Set the text to be spoken
			utterance.text = text;

			// Speak the text
			speechSynthesis.speak(utterance);
		}
	</script>
</body>
</html> -->

<!-- 
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Record audio and save as MP3</title>
  </head>
  <body>
    <button id="record">Record</button>
    <button id="stop">Stop</button>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.3.0/"></script>
    <script>
      let mediaRecorder;
      let audioChunks = [];

      const startRecording = () => {
        audioChunks = [];
        const audioStream = navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(audioStream);
        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });
        mediaRecorder.addEventListener("stop", () => {
          const audioBlob = new Blob(audioChunks);
          const reader = new FileReader();
          reader.onloadend = () => {
            const lame = new lamejs();
            const mp3Encoder = new lame.Mp3Encoder(1, 44100, 128);
            const pcmData = new Int16Array(reader.result);
            const mp3Data = mp3Encoder.encodeBuffer(pcmData);
            const finalData = mp3Encoder.flush();
            const blob = new Blob([new Uint8Array(finalData)]);
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            const a = document.createElement("a");
            a.href = url;
            a.download = "recording.mp3";
            document.body.appendChild(a);
            a.click();
          };
          reader.readAsArrayBuffer(audioBlob);
        });
        mediaRecorder.start();
      };

      const stopRecording = () => {
        mediaRecorder.stop();
      };

      document.getElementById("record").addEventListener("click", startRecording);
      document.getElementById("stop").addEventListener("click", stopRecording);
    </script>
  </body>
</html> -->

<!-- 
<html>
  <head>
    <title>Recorder App</title>
    
  </head>
  <h2>Recorder App</h2>
  <p>
    <button type="button" id="record">Record</button>
    <button type="button" id="stopRecord" disabled>Stop</button>
  </p>
  <p>
    <audio id="recordedAudio"></audio>        
  </p>

  <script> 
    navigator.mediaDevices.getUserMedia({audio:true})
    .then(stream => {handlerFunction(stream)})

    function handlerFunction(stream) {
      rec = new MediaRecorder(stream);
      rec.ondataavailable = e => {
        audioChunks.push(e.data);
        if (rec.state == "inactive"){
          let blob = new Blob(audioChunks,{type:'audio/mp3'});
          recordedAudio.src = URL.createObjectURL(blob);
          recordedAudio.controls=true;
          recordedAudio.autoplay=true;
          sendData(blob)
          }
        }
      }
    
    function sendData(data) {}
      record.onclick = e => {
        record.disabled = true;
        record.style.backgroundColor = "blue"
        stopRecord.disabled=false;
        audioChunks = [];
        rec.start();
        }
      stopRecord.onclick = e => {
        record.disabled = false;
        stop.disabled=true;
        record.style.backgroundColor = "red"
        rec.stop();
        }
  </script>
</html> -->

<!DOCTYPE html>
<html>
<head>
  <title>Talk With AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
          body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        font-family: sans-serif;
        text-align: center;
        background-color: #f5f5f5;
      }

      h2 {
        margin-top: 0;
      }

      button {
        font-size: 16px;
        padding: 10px;
        border-radius: 5px;
        border: none;
        background-color: #2196f3;
        color: #fff;
        cursor: pointer;
        margin-right: 10px;
        outline: none;
      }

      button:disabled {
        background-color: #ccc;
        cursor: default;
      }

      #recordedAudio {
        margin-top: 20px;
        width: 300px;
        height: 50px;
        outline: none;
      }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <h2>Talk With AI</h2>
  <p>
    <button type="button" id="record">Record</button>
    <button type="button" id="stopRecord" disabled>Stop</button>
    <!-- <button type="button" id="upload" disabled>Submit</button> -->
  </p>
  <p>
    <audio id="recordedAudio"></audio>        
  </p>

  <script src="https://code.responsivevoice.org/responsivevoice.js?key=078h13HP"></script>

  <script>
    // responsiveVoice.speak("Text 1,2","UK English Male");

    $(document).ready(function() {
      let audioChunks = [];
      let rec;
      let recordedAudio = document.getElementById('recordedAudio');
      let recordButton = $('#record');
      let stopButton = $('#stopRecord');
      let uploadButton = $('#upload');

      navigator.mediaDevices.getUserMedia({audio:true})
      .then(stream => {handlerFunction(stream)})

      function handlerFunction(stream) {
        rec = new MediaRecorder(stream);
        rec.ondataavailable = e => {
          audioChunks.push(e.data);
          if (rec.state == "inactive"){
            let blob = new Blob(audioChunks,{type:'audio/mp3'});
            recordedAudio.src = URL.createObjectURL(blob);
            recordedAudio.controls=true;
            recordedAudio.autoplay=true;
            uploadButton.prop('disabled', false);
            sendData(blob)
          }
        }
      }

      function sendData(data) {
        let formData = new FormData();
        formData.append('audio_data', data, 'recording.mp3');
        $.ajax({
          type: 'POST',
          url: 'https://37soa.edu.gh/whisper_to_chat.php',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            // response = JSON.parse(response);
            // var utterance = new SpeechSynthesisUtterance();

            // function speak(text) {

            //     // Set the text to be spoken
            //     utterance.text = text;

            //     // Speak the text
            //     speechSynthesis.speak(utterance);
            // }

            // var utterance = new SpeechSynthesisUtterance();

            // function speak(text) {
            //     // Set the text to be spoken
            //     utterance.text = text;

            //     // Set the voice to use for speech synthesis
            //     utterance.voice = speechSynthesis.getVoices().filter(function(voice) {
            //         return voice.lang === 'en-US';
            //     })[0];

            //     // Set the speech rate
            //     utterance.rate = 1.2; // 1 is the default rate

            //     // Set the pitch (1 is the default pitch)
            //     utterance.pitch = 1.2;

            //     // Speak the text
            //     speechSynthesis.speak(utterance);
            // }

            // responsiveVoice.speak(response)

            // responsiveVoice.speak(response, "US English Male");

            // speak(response);
            // console.log("hello" + response);

            response = unescapeString(response);

                        // console.log("hi" + response);


            responsiveVoice.speak(response, "UK English Male", {pitch: 1});


            console.log(response);

          },
          error: function(jqXHR, status, error) {
            console.log('Error: ' + error);
          }
        });
      }

      function unescapeString(str) {
            return str.replace(/\\n/g, ' ')
                        .replace(/\\r/g, ' ')
                        .replace(/\\t/g, ' ')
                        .replace(/\\'/g, ' ')
                        .replace(/\\"/g, ' ')
                        .replace(/\\\\/g, ' ')
                        .replace(/\\/g, ' ');
      }

      recordButton.click(function() {
        recordButton.prop('disabled', true);
        recordButton.css('background-color', 'blue');
        stopButton.prop('disabled', false);
        audioChunks = [];
        rec.start();
      });

      stopButton.click(function() {
        recordButton.prop('disabled', false);
        stopButton.prop('disabled', true);
        recordButton.css('background-color', 'red');
        rec.stop();
      });

      uploadButton.click(function() {
        uploadButton.prop('disabled', true);
        uploadButton.css('background-color', 'green');
      });
    });

  </script>
</body>
</html>


